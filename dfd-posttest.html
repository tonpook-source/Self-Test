<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบทดสอบออนไลน์: แผนภาพกระแสข้อมูล (DFD)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            background-color: #f3f6fa; /* Light Blueish Gray background */
        }
        .card {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e6ed;
        }
        /* --- WINDOWS 11 Theme Colors (Modern Blue) --- */
        .header-color {
            color: #0078D4; /* Windows Primary Blue */
        }
        .button-color {
            background-color: #00A3FF; /* Vibrant Blue for buttons */
        }
        .button-color:hover {
            background-color: #0078D4; /* Darker Blue hover */
        }
        .option-button {
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            min-height: 48px; 
            display: flex; 
            align-items: center;
        }
        .option-button:hover:not(.option-selected) {
            background-color: #E6F2FF; /* Very light blue hover */
        }
        .option-selected {
            background-color: #003D99 !important; /* Dark Blue for selection */
            color: white !important;
            border-color: #003D99 !important;
        }
        /* --- END Windows 11 Theme Colors --- */

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        /* Custom modal styles */
        .modal {
            max-width: 90%;
            width: 400px;
        }

        /* Ensure input fields and buttons are easily tappable on mobile */
        input[type="text"], input[type="number"], button {
            touch-action: manipulation;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-700 font-medium" id="loading-message">กำลังโหลด...</p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div class="min-h-screen flex flex-col items-center p-4">
        
        <!-- Header -->
        <header class="w-full max-w-2xl text-center py-6">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800">ระบบแบบทดสอบออนไลน์</h1>
            <p class="text-xl header-color font-semibold mt-1">เรื่อง: แผนภาพกระแสข้อมูล (Data Flow Diagram - DFD)</p>
            <p class="text-sm text-gray-500 mt-1">ครูประจำรายวิชา ครูธนพล อ่อนพุก</p>
            <p class="text-lg header-color font-semibold mt-1">(Self-Assessment: แสดงผลคะแนนทันที)</p>
        </header>

        <!-- Main Content Area -->
        <main id="app-container" class="w-full max-w-2xl bg-white p-6 md:p-8 rounded-xl card mb-8">
            <!-- Content will be injected here -->
        </main>

        <!-- Custom Confirmation Modal -->
        <div id="modal-confirm" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50">
            <div class="modal bg-white p-6 rounded-xl card transform transition-all duration-300">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800">ยืนยันการทำรายการ</h3>
                <p id="modal-body" class="mb-6 text-gray-600">คุณต้องการส่งคำตอบหรือไม่? หลังจากส่งแล้วจะไม่สามารถแก้ไขได้</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="hideModal('modal-confirm')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition duration-150">ยกเลิก</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 button-color text-white rounded-lg hover:bg-blue-600 font-medium transition duration-150">ยืนยัน</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Application Script -->
    <script type="module">
        
        // --- QUIZ DATA ---
        const quizData = [
            {
                question: "1. แผนภาพกระแสข้อมูล (DFD) ระดับสูงสุดที่แสดงภาพรวมความสัมพันธ์ระหว่างระบบกับบุคคลภายนอกเรียกว่าอะไร?",
                options: ["DFD Level 0", "Context Diagram", "DFD Level 1", "System Flowchart"],
                correctAnswerIndex: 1
            },
            {
                question: "2. สัญลักษณ์รูปสี่เหลี่ยมมุมมน (หรือวงกลม) ในแผนภาพ DFD ใช้แทนองค์ประกอบใด?",
                options: ["แหล่งเก็บข้อมูล (Data Store)", "กระบวนการ (Process)", "บุคคลภายนอก (External Entity)", "ทิศทางข้อมูล (Data Flow)"],
                correctAnswerIndex: 1
            },
            {
                question: "3. ข้อใดคือ 'กฎเหล็ก' ที่สำคัญที่สุดในการเชื่อมต่อเส้นกระแสข้อมูล (Data Flow)?",
                options: ["ห้ามเชื่อมข้อมูลจาก Entity ไปยัง Entity โดยตรง", "ต้องมี Process อย่างน้อย 2 ตัวในทุกๆ ระดับ", "ห้ามมีการส่งข้อมูลเข้าสู่ Data Store", "เส้นข้อมูลต้องเป็นเส้นทึบเท่านั้น"],
                correctAnswerIndex: 0
            },
            {
                question: "4. DFD Level 0 มีความแตกต่างจาก Context Diagram อย่างไร?",
                options: ["Level 0 แสดงเฉพาะ Entity เท่านั้น", "Level 0 มีการระบุแหล่งเก็บข้อมูล (Data Store) เพิ่มเข้ามา", "Level 0 แสดงภาพรวมเพียงกระบวนการเดียว", "Level 0 ไม่ต้องมีเส้นกระแสข้อมูล"],
                correctAnswerIndex: 1
            },
            {
                question: "5. สัญลักษณ์รูปสี่เหลี่ยมเปิดด้านข้าง (หรือเส้นคู่ขนาน) ใช้แทนสิ่งใดในระบบ?",
                options: ["จุดรับ-ส่งข้อมูล", "ขั้นตอนการคำนวณ", "แหล่งเก็บข้อมูล (Data Store)", "ผู้ดูแลระบบ"],
                correctAnswerIndex: 2
            },
            {
                question: "6. การรักษาความสมดุล (Balancing) ของ DFD หมายถึงข้อใด?",
                options: ["การวาดสัญลักษณ์ให้มีขนาดเท่ากัน", "การทำให้จำนวนเส้นเข้าและออกของกระบวนการในระดับแม่และระดับลูกต้องตรงกัน", "การตั้งชื่อกระบวนการให้มีความยาวเท่ากัน", "การจัดวางสัญลักษณ์ให้สวยงามซ้าย-ขวาเท่ากัน"],
                correctAnswerIndex: 1
            },
            {
                question: "7. บุคคลภายนอก หรือ External Entity ใน DFD หมายถึงข้อใด?",
                options: ["พนักงานฝ่ายไอทีที่ดูแลฐานข้อมูล", "ซอฟต์แวร์ระบบปฏิบัติการ", "บุคคลหรือระบบอื่นที่รับ-ส่งข้อมูลกับระบบแต่ไม่ได้อยู่ในขอบเขตระบบนั้น", "ตัวแปรที่ใช้ภายในโปรแกรม"],
                correctAnswerIndex: 2
            },
            {
                question: "8. ข้อผิดพลาดที่เรียกว่า 'Black Hole' ใน DFD คือสถานการณ์ใด?",
                options: ["กระบวนการที่มีข้อมูลเข้า แต่ไม่มีข้อมูลออก", "กระบวนการที่ไม่มีข้อมูลเข้า แต่มีข้อมูลออก", "กระบวนการที่ไม่มีทั้งข้อมูลเข้าและออก", "เส้นข้อมูลที่วนกลับมาหาตัวเอง"],
                correctAnswerIndex: 0
            },
            {
                question: "9. ทุกๆ กระบวนการ (Process) จะต้องมีลักษณะการทำงานที่ถูกต้องตามข้อใด?",
                options: ["ต้องมีข้อมูลเข้า (Input) เท่านั้น", "ต้องมีข้อมูลออก (Output) เท่านั้น", "ต้องมีทั้งข้อมูลเข้า (Input) และข้อมูลออก (Output)", "ต้องเชื่อมต่อกับ Data Store เสมอ"],
                correctAnswerIndex: 2
            },
            {
                question: "10. ข้อผิดพลาดที่เรียกว่า 'Miracle' ใน DFD คือสถานการณ์ใด?",
                options: ["กระบวนการที่มีข้อมูลเข้า แต่ไม่มีข้อมูลออก", "กระบวนการที่ไม่มีข้อมูลเข้า แต่มีข้อมูลออก", "กระบวนการที่รับข้อมูลจาก 2 แหล่งพร้อมกัน", "การส่งข้อมูลจาก Data Store หนึ่งไปยังอีกที่หนึ่งโดยไม่ผ่าน Process"],
                correctAnswerIndex: 1
            }
        ];

        // --- QUIZ CONSTANTS ---
        const thaiOptions = ['ก', 'ข', 'ค', 'ง'];
        const TIME_LIMIT_SECONDS = 600; // 10 minutes

        // --- QUIZ STATE ---
        let currentQuestionIndex = 0;
        let selectedAnswers = new Array(quizData.length).fill(null);
        let studentName = '';
        let studentId = ''; 
        let timeLeft = TIME_LIMIT_SECONDS;
        let timerInterval = null;

        // --- APPLICATION FLOW ---

        window.onload = () => {
            hideLoading(); 
            window.showLoginView();
        }

        // --- TIMER FUNCTIONS ---

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            const timerElement = document.getElementById('timer-display');
            if (timerElement) {
                timerElement.textContent = display;
                if (timeLeft <= 60) {
                    timerElement.classList.add('animate-pulse', 'text-red-600');
                } else {
                    timerElement.classList.remove('text-red-600', 'animate-pulse');
                    timerElement.classList.add('text-gray-800');
                }
            }
        }

        function startTimer() {
            window.stopTimer();
            timerInterval = setInterval(() => {
                timeLeft--;
                window.updateTimerDisplay();
                if (timeLeft <= 0) {
                    window.stopTimer();
                    window.showModal('หมดเวลาทำข้อสอบ', 'ระบบจะส่งคำตอบอัตโนมัติ', false);
                    setTimeout(() => { 
                        window.hideModal('modal-confirm');
                        window.submitQuiz(true); 
                    }, 2000);
                }
            }, 1000);
        }

        window.stopTimer = function() {
            if (timerInterval) clearInterval(timerInterval);
        }
        window.updateTimerDisplay = updateTimerDisplay;
        window.startTimer = startTimer;

        // --- UI MANAGEMENT ---

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- LOGIN VIEW ---

        window.showLoginView = function() {
            window.stopTimer();
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-700 text-center">เข้าสู่ระบบแบบทดสอบ</h2>
                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล:</label>
                        <input type="text" id="student-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ระบุชื่อ-นามสกุล">
                    </div>
                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-gray-700">เลขที่:</label>
                        <input type="number" id="student-id" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ระบุเลขที่">
                    </div>
                    <button onclick="startQuiz()" class="w-full py-3 mt-4 button-color text-white rounded-lg font-bold text-lg hover:bg-blue-700 transition duration-150 shadow-md">
                        เริ่มทำแบบทดสอบ DFD (10 ข้อ)
                    </button>
                </div>
            `;
        }

        window.startQuiz = function() {
            studentName = document.getElementById('student-name').value.trim();
            studentId = document.getElementById('student-id').value.trim();

            if (!studentName || !studentId) {
                window.showModal('กรุณากรอกข้อมูล', 'ต้องระบุ ชื่อ-นามสกุล และ เลขที่', false);
                return;
            }

            currentQuestionIndex = 0;
            selectedAnswers = new Array(quizData.length).fill(null);
            timeLeft = TIME_LIMIT_SECONDS;
            window.startTimer();
            window.showQuizView();
        }

        // --- QUIZ VIEW ---

        function showQuizView() {
            const container = document.getElementById('app-container');
            const q = quizData[currentQuestionIndex];
            
            const optionsHtml = q.options.map((option, index) => {
                const isSelected = selectedAnswers[currentQuestionIndex] === index;
                const selectedClass = isSelected ? 'option-selected' : 'bg-gray-50 text-gray-700 hover:bg-gray-100';
                return `
                    <button data-option-index="${index}" onclick="selectAnswer(${index})" class="option-button w-full text-left p-4 border border-gray-300 rounded-xl font-medium ${selectedClass}">
                        <span class="mr-2">${thaiOptions[index]}.</span> ${option} 
                    </button>
                `;
            }).join('');

            container.innerHTML = `
                <div class="space-y-6">
                    <div class="text-center">
                        <p class="text-sm font-semibold header-color">${studentName} (เลขที่: ${studentId})</p>
                        <p class="text-xl font-bold text-gray-800 mt-1">คำถามที่ ${currentQuestionIndex + 1} / ${quizData.length}</p>
                        <div class="h-1 bg-gray-200 rounded-full mt-3">
                            <div class="button-color h-1 rounded-full transition-all duration-300" style="width: ${((currentQuestionIndex + 1) / quizData.length) * 100}%"></div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center bg-yellow-50 border border-yellow-200 p-3 rounded-xl font-bold text-gray-800 mt-4 shadow-sm">
                        <p>เวลาที่เหลือ:</p>
                        <div id="timer-display" class="text-2xl text-gray-800 font-mono">--:--</div>
                    </div>

                    <div class="bg-white p-5 border border-gray-200 rounded-xl">
                        <p class="text-lg font-semibold text-gray-900">${q.question}</p>
                    </div>

                    <div id="options-container" class="space-y-3">${optionsHtml}</div>

                    <div class="flex justify-between pt-4">
                        <button onclick="prevQuestion()" class="px-5 py-3 bg-gray-100 text-gray-600 rounded-lg font-semibold transition duration-150 ${currentQuestionIndex === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'}">
                            ย้อนกลับ
                        </button>
                        <button onclick="${currentQuestionIndex === quizData.length - 1 ? 'confirmSubmission()' : 'nextQuestion()'}" class="px-5 py-3 button-color text-white rounded-lg font-bold transition duration-150 hover:bg-blue-700 shadow-md">
                            ${currentQuestionIndex === quizData.length - 1 ? 'ส่งคำตอบ' : 'ข้อถัดไป'}
                        </button>
                    </div>
                </div>
            `;
            window.updateTimerDisplay();
        }
        
        window.showQuizView = showQuizView;

        // Optimized Answer Selection to prevent flickering
        window.selectAnswer = function(index) {
            selectedAnswers[currentQuestionIndex] = index;
            
            // Update button styles directly without re-rendering the whole view
            const buttons = document.querySelectorAll('[data-option-index]');
            buttons.forEach((btn, i) => {
                if (parseInt(btn.getAttribute('data-option-index')) === index) {
                    btn.classList.add('option-selected');
                    btn.classList.remove('bg-gray-50', 'text-gray-700', 'hover:bg-gray-100');
                } else {
                    btn.classList.remove('option-selected');
                    btn.classList.add('bg-gray-50', 'text-gray-700', 'hover:bg-gray-100');
                }
            });
        }

        window.prevQuestion = () => { if (currentQuestionIndex > 0) { currentQuestionIndex--; window.showQuizView(); } }
        window.nextQuestion = () => { 
            if (selectedAnswers[currentQuestionIndex] === null) { window.showModal('ยังไม่ได้เลือกคำตอบ', 'กรุณาเลือกคำตอบก่อน', false); return; }
            if (currentQuestionIndex < quizData.length - 1) { currentQuestionIndex++; window.showQuizView(); }
        }

        window.confirmSubmission = function() {
            if (selectedAnswers.includes(null)) { window.showModal('ยังตอบไม่ครบ', 'กรุณาตอบให้ครบทุกข้อก่อนส่ง', false); return; }
            window.showModal('ยืนยันการส่งคำตอบ', 'คุณต้องการส่งคำตอบหรือไม่?', true, window.submitQuiz);
        }

        window.submitQuiz = function() {
            window.stopTimer();
            window.hideModal('modal-confirm');
            let score = 0;
            quizData.forEach((q, i) => { if (selectedAnswers[i] === q.correctAnswerIndex) score++; });
            window.showResultView(score, quizData.length);
        }

        window.showResultView = function(score, total) {
            const container = document.getElementById('app-container');
            const percentage = ((score / total) * 100).toFixed(0);
            container.innerHTML = `
                <div class="text-center space-y-6 py-6 animate-fadeIn">
                    <h2 class="text-3xl font-extrabold text-gray-800">ผลการทดสอบ</h2>
                    <p class="text-lg text-gray-600">${studentName} (เลขที่: ${studentId})</p>
                    <div class="p-8 rounded-xl inline-block shadow-lg" style="background-color: #fffbeb; border: 3px solid #0078D4">
                        <p class="text-6xl font-black header-color">${score}</p>
                        <p class="text-xl font-semibold text-gray-600 mt-2">คะแนน (จาก ${total} ข้อ)</p>
                    </div>
                    <p class="text-2xl font-bold header-color">${percentage}%</p>
                    <button onclick="showLoginView()" class="w-full py-3 mt-8 button-color text-white rounded-lg font-bold text-lg hover:bg-blue-700 shadow-md">ทำแบบทดสอบใหม่</button>
                </div>
            `;
        }

        window.showModal = function(t, b, isC, cb) {
            const m = document.getElementById('modal-confirm');
            document.getElementById('modal-title').textContent = t;
            document.getElementById('modal-body').textContent = b;
            const btn = document.getElementById('modal-confirm-btn');
            if (isC) { btn.classList.remove('hidden'); btn.onclick = cb; } else btn.classList.add('hidden');
            m.style.display = 'flex';
        }

        window.hideModal = (id) => document.getElementById(id).style.display = 'none';

    </script>
</body>
</html>